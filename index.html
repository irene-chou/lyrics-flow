<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lyrics Flow - 歌詞播放器</title>
<script src="https://unpkg.com/piesocket-js@5"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-card: #1a1a26;
    --bg-input: #22222e;
    --border: #2a2a3a;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a0;
    --text-dim: #55556a;
    --accent: #7c6aef;
    --accent-glow: rgba(124, 106, 239, 0.3);
    --active-lyric: #ffffff;
    --active-bg: rgba(124, 106, 239, 0.15);
    --passed-lyric: #5a5a70;
    --upcoming-lyric: #9090a8;
    --danger: #ef4444;
    --success: #22c55e;
    --sidebar-width: 360px;

    --radius: 12px;
    --font-main: 'Noto Sans TC', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-main);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ========== Layout ========== */
  .app {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr;
    grid-template-rows: auto 1fr;
    height: 100vh;
    gap: 0;
  }

  .header {
    grid-column: 1 / -1;
    padding: 12px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .header .song-indicator {
    flex: 1;
    min-width: 0;
    max-width: 320px;
  }

  .header h1 {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header h1 .dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent-glow);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-left: auto;
    flex-shrink: 0;
  }
  .btn-obs-url {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: 11px;
    font-weight: 600;
    font-family: var(--font-mono);
    letter-spacing: 0.03em;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-obs-url:hover {
    color: var(--text-primary);
    border-color: var(--accent);
  }
  .btn-obs-url.copied {
    color: var(--success);
    border-color: var(--success);
  }
  .btn-obs-url .obs-url-icon.check { display: none; }
  .btn-obs-url.copied .obs-url-icon.link { display: none; }
  .btn-obs-url.copied .obs-url-icon.check { display: block; }

  .song-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--bg-card);
    border-radius: 8px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
  }
  .song-indicator:hover {
    border-color: var(--accent);
    background: rgba(124, 106, 239, 0.05);
  }
  .song-indicator.editing {
    border-color: var(--accent);
    cursor: default;
  }
  .song-indicator.editing:hover {
    background: var(--bg-card);
  }
  .song-indicator-icon {
    color: var(--accent);
    flex-shrink: 0;
    display: flex;
  }
  .song-indicator-info {
    flex: 1;
    min-width: 0;
  }
  .song-indicator-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .song-indicator-name.unsaved {
    color: var(--text-secondary);
    font-style: italic;
  }
  input[type="text"].song-name-input,
  input[type="text"].song-name-input:focus {
    font-size: 13px;
    font-weight: 500;
    font-family: var(--font-main);
    color: var(--text-primary);
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 0;
    margin: 0;
    outline: none;
    box-shadow: none;
    width: 100%;
    height: auto;
    line-height: inherit;
    caret-color: var(--accent);
    -webkit-appearance: none;
  }
  .song-indicator-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }
  .btn-icon {
    padding: 4px;
    border-radius: 6px;
    border: none;
    background: none;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: all 0.15s;
  }
  .btn-icon:hover {
    background: var(--bg-input);
    color: var(--text-primary);
  }

  .mode-badge {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text-secondary);
  }

  .mode-badge.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(124, 106, 239, 0.08);
  }

  /* ========== Control Panel (Left) ========== */
  .control-panel {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .panel-heading {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .input-row {
    display: flex;
    gap: 8px;
  }

  input[type="text"], textarea {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input[type="text"]:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  textarea {
    font-family: var(--font-main);
    font-size: 13px;
    resize: vertical;
    min-height: 180px;
    line-height: 1.7;
  }

  .btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-input);
    color: var(--text-primary);
    font-family: var(--font-main);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
  }

  .btn:hover {
    background: var(--bg-card);
    border-color: var(--text-dim);
  }

  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    font-weight: 600;
  }

  .btn-primary:hover {
    background: #6b59de;
    border-color: #6b59de;
    box-shadow: 0 4px 20px var(--accent-glow);
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  .btn-danger {
    border-color: var(--danger);
    color: var(--danger);
  }

  .btn-danger:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  /* YouTube Player Container */
  .player-wrapper {
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    aspect-ratio: 16/9;
    position: relative;
  }

  .player-wrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Playback Info */
  .playback-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
  }

  .time-display {
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--text-secondary);
    min-width: 110px;
  }

  .progress-bar {
    flex: 1;
    height: 4px;
    background: var(--bg-input);
    border-radius: 2px;
    position: relative;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s linear;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
  }

  .status-dot.playing {
    background: var(--success);
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .status-dot.paused {
    background: #eab308;
  }

  /* Offset Control */
  .offset-control {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .offset-control .offset-value {
    font-family: var(--font-mono);
    font-size: 13px;
    min-width: 60px;
    text-align: center;
    color: var(--accent);
    font-weight: 600;
  }

  /* Lyrics Source Info */
  .lyrics-info {
    font-size: 12px;
    color: var(--text-secondary);
    padding: 8px 12px;
    background: var(--bg-input);
    border-radius: 8px;
    font-family: var(--font-mono);
    line-height: 1.6;
  }

  .lyrics-info .count {
    color: var(--accent);
    font-weight: 600;
  }

  /* ========== Lyrics Display (Right) ========== */
  .lyrics-display {
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .lyrics-scroll-container {
    flex: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    padding: 30vh 48px 30vh 80px;
    position: relative;
  }

  .lyrics-scroll-container::-webkit-scrollbar {
    width: 4px;
  }

  .lyrics-scroll-container::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
  }

  .lyric-line {
    padding: 12px 20px;
    margin: 4px 0;
    border-radius: 10px;
    font-size: 28px;
    font-weight: 400;
    line-height: 1.6;
    color: var(--text-dim);
    transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    cursor: pointer;
    position: relative;
  }

  .lyric-line:hover {
    background: rgba(255, 255, 255, 0.03);
  }

  .lyric-line.passed {
    color: var(--passed-lyric);
    font-weight: 400;
  }

  .lyric-line.active {
    color: var(--active-lyric);
    font-weight: 700;
    font-size: 32px;
    background: var(--active-bg);
    transform: scale(1.01);
    padding: 16px 24px;
  }

  .lyric-line.upcoming {
    color: var(--upcoming-lyric);
  }

  .lyric-line .time-tag {
    position: absolute;
    left: -68px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    font-family: var(--font-mono);
    color: var(--text-dim);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .lyric-line:hover .time-tag {
    opacity: 1;
  }

  /* Interlude / instrumental indicator */
  .lyric-line.interlude {
    font-size: 16px;
    font-style: italic;
    color: var(--text-dim);
    letter-spacing: 0.05em;
  }

  .lyric-line.interlude::before {
    content: '♪';
    margin-right: 8px;
    opacity: 0.5;
  }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    text-align: center;
    padding: 48px;
    gap: 16px;
  }

  .empty-state .icon {
    font-size: 48px;
    opacity: 0.3;
  }

  .empty-state p {
    font-size: 15px;
    line-height: 1.8;
  }

  /* ========== OBS Overlay Mode ========== */
  body.obs-mode {
    background: transparent !important;
  }

  body.obs-mode .app {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
    background: transparent;
  }

  body.obs-mode .header,
  body.obs-mode .control-panel,
  body.obs-mode .fab {
    display: none !important;
  }

  body.obs-mode .lyrics-display {
    background: transparent;
  }

  body.obs-mode .lyrics-scroll-container {
    padding: 20vh 32px;
  }

  body.obs-mode .lyric-line {
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    font-size: 36px;
  }

  body.obs-mode .lyric-line.active {
    font-size: 42px;
    text-shadow: 0 0 20px var(--accent-glow), 0 2px 8px rgba(0,0,0,0.8);
  }

  /* ========== Tabs ========== */
  .tabs {
    display: flex;
    gap: 2px;
    background: var(--bg-input);
    border-radius: 8px;
    padding: 3px;
  }

  .tab {
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s;
    border: none;
    background: transparent;
    font-family: var(--font-main);
  }

  .tab.active {
    background: var(--bg-card);
    color: var(--text-primary);
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }

  /* ========== Sample LRC hint ========== */
  .hint {
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.6;
    padding: 8px 0;
  }

  .hint code {
    font-family: var(--font-mono);
    background: var(--bg-input);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 10px;
  }
  .hint a {
    color: var(--accent);
    text-decoration: none;
  }
  .hint a:hover {
    text-decoration: underline;
  }

  /* ========== Manual Timer Mode ========== */
  .manual-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .manual-controls .timer-display {
    font-family: var(--font-mono);
    font-size: 24px;
    font-weight: 600;
    color: var(--accent);
    min-width: 80px;
    text-align: center;
  }

  .embed-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px;
    background: var(--bg-input);
    border-radius: var(--radius);
    border: 1px dashed var(--border);
    text-align: center;
    aspect-ratio: 16/9;
  }

  .embed-error p {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .embed-error .error-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--danger);
  }

  /* ========== Font Size Control ========== */
  .font-size-control {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .font-size-control span {
    font-size: 12px;
    color: var(--text-secondary);
    font-family: var(--font-mono);
    min-width: 36px;
    text-align: center;
  }

  /* Song Library Drawer */
  .drawer-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  .drawer-backdrop.open {
    opacity: 1;
    pointer-events: auto;
  }
  .song-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: 380px;
    height: 100vh;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border);
    z-index: 101;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
  }
  .drawer-backdrop.open .song-drawer {
    transform: translateX(0);
  }
  .song-drawer-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .song-drawer-body {
    padding: 16px 24px;
    overflow: hidden;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .song-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .song-list-empty {
    color: var(--text-secondary);
    font-size: 12px;
    text-align: center;
    padding: 24px 0;
  }
  .song-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 13px;
    color: var(--text-primary);
  }
  .song-item:hover {
    background: var(--bg-input);
  }
  .song-item.active {
    background: var(--accent);
    color: #fff;
  }
  .song-item-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .song-item-actions {
    display: none;
    gap: 4px;
  }
  .song-item:hover .song-item-actions,
  .song-item.active .song-item-actions {
    display: flex;
  }
  .song-item-actions button {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    display: flex;
    align-items: center;
  }
  .song-item:hover .song-item-actions button {
    color: var(--text-primary);
  }
  .song-item.active .song-item-actions button {
    color: rgba(255,255,255,0.7);
  }
  .song-item-actions button:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
  }
  .drawer-menu {
    position: relative;
  }
  .drawer-menu-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    min-width: 120px;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .drawer-menu-dropdown.open {
    display: block;
  }
  .drawer-menu-dropdown button {
    display: block;
    width: 100%;
    padding: 8px 12px;
    background: none;
    border: none;
    color: var(--text-primary);
    font-family: var(--font-main);
    font-size: 12px;
    text-align: left;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.15s;
  }
  .drawer-menu-dropdown button:hover {
    background: var(--bg-input);
  }

  .sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .section-label-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .btn-reset {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.15s, background 0.15s;
  }
  .btn-reset:hover {
    color: var(--accent);
    background: rgba(124, 106, 239, 0.08);
  }
  /* FAB */
  .fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: var(--accent);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(124, 106, 239, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 50;
  }
  .fab:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(124, 106, 239, 0.5);
  }
  .fab:active {
    transform: scale(0.95);
  }

  /* Responsive: if narrow, stack */
  @media (max-width: 900px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto 1fr;
    }
    .control-panel {
      border-right: none;
      border-bottom: 1px solid var(--border);
      max-height: 50vh;
    }
    .song-drawer {
      width: 100%;
    }
    .header .song-indicator {
      max-width: 180px;
    }
  }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1><span class="dot"></span>Lyrics Flow</h1>
    </div>
    <div class="song-indicator" id="songIndicator" onclick="toggleSongDrawer()" title="開啟歌曲庫">
      <div class="song-indicator-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12,3V12.26C11.5,12.09 11,12 10.5,12A4.5,4.5 0 0,0 6,16.5A4.5,4.5 0 0,0 10.5,21A4.5,4.5 0 0,0 15,16.5V6H19V3H12Z" />
        </svg>
      </div>
      <div class="song-indicator-info">
        <div class="song-indicator-name unsaved" id="songIndicatorName">未儲存的歌曲</div>
      </div>
      <div class="song-indicator-actions">
        <button class="btn-icon" onclick="event.stopPropagation(); startEditSongName()" title="編輯歌曲名稱">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
          </svg>
        </button>
      </div>
    </div>
    <div class="header-actions">
      <span class="mode-badge" id="statusBadge" style="display:none;">IDLE</span>
      <button class="btn-obs-url" id="obsUrlBtn" onclick="copyOBSUrl()" title="複製 OBS 瀏覽器來源 URL">
        <span>OBS</span>
        <svg class="obs-url-icon link" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12.71,4.22C14.66,2.27 17.83,2.27 19.78,4.22C21.73,6.17 21.73,9.34 19.78,11.29L18.29,12.78C18.3,11.96 18.17,11.14 17.89,10.36L18.36,9.88C19.54,8.71 19.54,6.81 18.36,5.64C17.19,4.46 15.29,4.46 14.12,5.64L10.59,9.17C9.41,10.34 9.41,12.24 10.59,13.41M13.41,9.17C13.8,8.78 14.44,8.78 14.83,9.17C16.78,11.12 16.78,14.29 14.83,16.24V16.24L11.29,19.78C9.34,21.73 6.17,21.73 4.22,19.78C2.27,17.83 2.27,14.66 4.22,12.71L5.71,11.22C5.7,12.04 5.83,12.86 6.11,13.65L5.64,14.12C4.46,15.29 4.46,17.19 5.64,18.36C6.81,19.54 8.71,19.54 9.88,18.36L13.41,14.83C14.59,13.66 14.59,11.76 13.41,10.59C13,10.2 13,9.56 13.41,9.17Z" />
        </svg>
        <svg class="obs-url-icon check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Left: Control Panel -->
  <div class="control-panel">
    <div class="sidebar-content">

    <!-- Audio Source Tabs -->
    <div class="input-group">
      <div class="section-label-row">
        <div class="section-label">伴奏來源</div>
        <button class="btn-reset" onclick="clearCurrentSong()" title="清空內容以新增下一首">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10" />
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
          </svg>
        </button>
        </div>
      <div class="tabs" id="audioSourceTabs">
        <button class="tab active" onclick="switchAudioSource('youtube', this)">YouTube</button>
        <button class="tab" onclick="switchAudioSource('local', this)">本地音檔</button>
      </div>
    </div>

    <!-- YouTube Source -->
    <div id="audioSourceYoutube">
      <div class="input-group">
        <div class="input-row">
          <input type="text" id="ytUrl" placeholder="貼上 YouTube 連結或影片 ID" />
          <button class="btn btn-primary" onclick="loadVideo()">載入</button>
        </div>
      </div>

      <!-- Player (embed mode) -->
      <div id="embedMode">
        <div class="player-wrapper">
          <div id="ytPlayer"></div>
        </div>
        <div class="playback-info">
          <div class="status-dot" id="statusDot"></div>
          <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
          <div class="progress-bar" id="progressBar" onclick="seekFromBar(event)">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>

      <!-- Manual timer (fallback when embed blocked) -->
      <div id="manualMode" style="display:none;">
        <div class="embed-error">
          <div class="error-title">此影片不允許嵌入播放</div>
          <p>請在其他視窗開啟 YouTube 播放伴奏，<br>然後用下方計時器手動同步歌詞。</p>
          <button class="btn btn-sm" id="openYtBtn" onclick="openYouTubeExternal()">在新視窗開啟 YouTube</button>
        </div>
        <div style="margin-top: 12px;">
          <div class="section-label">手動計時器</div>
          <div class="manual-controls">
            <button class="btn btn-primary" id="manualPlayBtn" onclick="manualTogglePlay()">▶ 開始</button>
            <span class="timer-display" id="manualTimerDisplay">00:00</span>
            <button class="btn btn-sm" onclick="manualSeek(-5)">-5s</button>
            <button class="btn btn-sm" onclick="manualSeek(5)">+5s</button>
            <button class="btn btn-sm btn-danger" onclick="manualReset()">重置</button>
          </div>
          <div class="hint" style="margin-top:6px;">
            提示：在 YouTube 按播放的同時點「開始」，歌詞就會同步滾動。
          </div>
        </div>
      </div>
    </div>

    <!-- Local Audio Source -->
    <div id="audioSourceLocal" style="display:none;">
      <div class="input-group">
        <div class="input-row">
          <input type="text" id="audioFileName" placeholder="點擊選擇音檔（mp3, m4a, wav, ogg...）" readonly
                 onclick="document.getElementById('audioFileInput').click()" style="cursor:pointer;" />
          <button class="btn btn-primary" onclick="document.getElementById('audioFileInput').click()">選擇檔案</button>
        </div>
        <input type="file" id="audioFileInput" accept="audio/*" onchange="loadAudioFile(event)" style="display:none;" />
      </div>
      <audio id="audioPlayer" style="display:none;"></audio>
      <div class="playback-info" id="audioPlaybackInfo" style="display:none;">
        <div class="status-dot" id="audioStatusDot"></div>
        <div class="time-display" id="audioTimeDisplay">00:00 / 00:00</div>
        <div class="progress-bar" id="audioProgressBar" onclick="audioSeekFromBar(event)">
          <div class="progress-fill" id="audioProgressFill"></div>
        </div>
      </div>
      <div class="manual-controls" id="audioControls" style="display:none;">
        <button class="btn btn-primary" id="audioPlayBtn" onclick="audioTogglePlay()">▶ 播放</button>
        <button class="btn btn-sm" onclick="audioSeek(-5)">-5s</button>
        <button class="btn btn-sm" onclick="audioSeek(5)">+5s</button>
      </div>
    </div>

    <!-- LRC Lyrics Input -->
    <div class="input-group">
      <div class="section-label">LRC 歌詞</div>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('paste', this)">貼上歌詞</button>
        <button class="tab" onclick="switchTab('file', this)">讀取檔案</button>
      </div>

      <div id="tabPaste">
        <textarea id="lrcInput" placeholder="在此貼上 LRC 格式歌詞...&#10;&#10;範例：&#10;[00:12.50]第一句歌詞&#10;[00:18.30]第二句歌詞&#10;[00:24.10]第三句歌詞"></textarea>
        <button class="btn" onclick="parseLRC()" style="margin-top:6px; width:100%;">解析歌詞</button>
      </div>

      <div id="tabFile" style="display:none;">
        <input type="text" id="lrcFileInput" placeholder="點擊選擇 .lrc 檔案" readonly onclick="document.getElementById('fileInput').click()" style="cursor:pointer;" />
        <input type="file" id="fileInput" accept=".lrc,.txt" onchange="loadLRCFile(event)" style="display:none;" />
      </div>

      <div class="hint">
        提示：可從 <a href="https://lrclib.net" target="_blank">lrclib.net</a> 或 <a href="https://www.megalobiz.com" target="_blank">megalobiz.com</a> 搜尋下載中文歌的 LRC 檔。
      </div>
    </div>

    <!-- Lyrics Info -->
    <div class="lyrics-info" id="lyricsInfo" style="display:none;">
      已載入 <span class="count" id="lineCount">0</span> 行歌詞
    </div>

    <!-- Offset -->
    <div class="input-group">
      <div class="section-label">歌詞偏移 (Offset)</div>
      <div class="offset-control">
        <button class="btn btn-sm" onclick="adjustOffset(-0.5)">-0.5s</button>
        <button class="btn btn-sm" onclick="adjustOffset(-0.1)">-0.1s</button>
        <span class="offset-value" id="offsetDisplay">0.0s</span>
        <button class="btn btn-sm" onclick="adjustOffset(0.1)">+0.1s</button>
        <button class="btn btn-sm" onclick="adjustOffset(0.5)">+0.5s</button>
      </div>
      <div class="hint">如果歌詞跑太快或太慢，可以微調偏移量。</div>
    </div>

    <!-- Font Size & Line Height -->
    <div class="input-group">
      <div class="section-label">歌詞字體大小</div>
      <div class="font-size-control">
        <button class="btn btn-sm" onclick="adjustFontSize(-2)">A-</button>
        <span id="fontSizeDisplay">28px</span>
        <button class="btn btn-sm" onclick="adjustFontSize(2)">A+</button>
      </div>
    </div>
    <div class="input-group">
      <div class="section-label">歌詞行距</div>
      <div class="font-size-control">
        <button class="btn btn-sm" onclick="adjustLineHeight(-0.1)">-</button>
        <span id="lineHeightDisplay">1.6</span>
        <button class="btn btn-sm" onclick="adjustLineHeight(0.1)">+</button>
      </div>
    </div>

    </div><!-- /sidebar-content -->
    </div><!-- /control-panel -->

  <!-- Right: Lyrics Display -->
  <div class="lyrics-display">
    <div class="lyrics-scroll-container" id="lyricsContainer">
      <div class="empty-state" id="emptyState">
        <div class="icon">♪</div>
        <p>
          1. 貼上 YouTube 伴奏連結<br>
          2. 貼上或載入 LRC 歌詞<br>
          3. 播放後歌詞會自動同步滾動
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Save FAB -->
<button class="fab" id="saveBtn" onclick="saveCurrent()" title="儲存歌曲 (Ctrl+S)">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
    <polyline points="17 21 17 13 7 13 7 21" />
    <polyline points="7 3 7 8 15 8" />
  </svg>
</button>

<!-- Song Library Drawer -->
<div class="drawer-backdrop" id="drawerBackdrop" onclick="closeSongDrawer()">
  <div class="song-drawer" onclick="event.stopPropagation()">
    <div class="song-drawer-header">
      <h2 class="panel-heading">歌曲庫</h2>
      <div class="drawer-menu">
        <button class="btn-icon" onclick="toggleDrawerMenu(event)" title="更多">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>
        </button>
        <div class="drawer-menu-dropdown" id="drawerMenuDropdown">
          <button onclick="exportSongs(); closeDrawerMenu()">匯出歌曲庫</button>
          <button onclick="document.getElementById('importFileInput').click(); closeDrawerMenu()">匯入歌曲庫</button>
        </div>
      </div>
    </div>
    <div class="song-drawer-body" onclick="closeDrawerMenu()">
      <div class="input-row" style="align-items:stretch;">
        <input type="text" id="songSearchInput" placeholder="搜尋歌曲..." oninput="filterSongList()" style="flex:1; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--text-primary); font-family:var(--font-main); font-size:13px; outline:none;" />
        <input type="file" id="importFileInput" accept=".json" onchange="importSongs(event)" style="display:none;" />
      </div>
      <div class="song-list" id="songList">
        <div class="song-list-empty">尚無歌曲</div>
      </div>
    </div>
  </div>
</div>

<!-- YouTube IFrame API -->
<script>
  // ========== State ==========
  let player = null;
  let lyrics = []; // [{time: seconds, text: "..."}, ...]
  let currentLineIndex = -1;
  let offset = 0;
  let baseFontSize = 28;
  let baseLineHeight = 1.6;
  let syncInterval = null;
  let isOBSMode = false;
  let useLocalAudio = false;
  let audioEl = null;
  let currentSongTitle = ''; // from LRC [ti:] or user input
  let currentSongId = null;  // null = new song, number = update existing
  let cachedSongs = [];       // cached song list for filtering


  // ========== IndexedDB (Song Library) ==========
  const DB_NAME = 'lyrics-flow-db';
  const DB_VERSION = 1;
  const STORE_NAME = 'songs';

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveSong(song) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).put(song);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getAllSongs() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const req = tx.objectStore(STORE_NAME).getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function deleteSong(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).delete(id);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  // ========== Song Library Functions ==========
  async function refreshSongList() {
    cachedSongs = await getAllSongs();
    cachedSongs.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    renderSongList(cachedSongs);
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function renderSongList(songs) {
    const list = document.getElementById('songList');
    if (songs.length === 0) {
      const query = document.getElementById('songSearchInput').value.trim();
      list.innerHTML = `<div class="song-list-empty">${query ? '找不到符合的歌曲' : '尚無歌曲'}</div>`;
      return;
    }
    const deleteIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>';
    list.innerHTML = songs.map(s => {
      const safeName = escapeHtml(s.name);
      return `
      <div class="song-item${currentSongId === s.id ? ' active' : ''}" data-id="${s.id}" onclick="loadSongById(${s.id})">
        <span class="song-item-name">${safeName}</span>
        <span class="song-item-actions">
          <button onclick="event.stopPropagation(); deleteSongById(${s.id}, '${safeName.replace(/'/g, "\\'")}')" title="刪除">${deleteIcon}</button>
        </span>
      </div>`;
    }).join('');
  }

  function filterSongList() {
    const query = document.getElementById('songSearchInput').value.trim().toLowerCase();
    if (!query) { renderSongList(cachedSongs); return; }
    const filtered = cachedSongs.filter(s => s.name.toLowerCase().includes(query));
    renderSongList(filtered);
  }

  async function saveCurrent() {
    const lrcText = document.getElementById('lrcInput').value.trim();
    if (!lrcText && lyrics.length === 0) {
      alert('請先載入歌詞再儲存。');
      return;
    }

    const btn = document.getElementById('saveBtn');
    let name;

    if (currentSongId) {
      // Update mode: use existing name, same id
      name = currentSongTitle || '未命名歌曲';
    } else {
      // New mode: prompt for name
      const defaultName = currentSongTitle || '未命名歌曲';
      name = prompt('輸入歌曲名稱：', defaultName);
      if (!name) return;
    }

    const song = {
      id: currentSongId || Date.now(),
      name: name,
      lrcText: lrcText,
      offset: offset,
      audioSource: useLocalAudio ? 'local' : 'youtube',
      youtubeId: useLocalAudio ? null : (currentVideoId || null),
      audioFileName: useLocalAudio ? (document.getElementById('audioFileName').value || null) : null,
      updatedAt: Date.now(),
    };
    if (currentSongId) {
      const songs = await getAllSongs();
      const existing = songs.find(s => s.id === currentSongId);
      song.createdAt = existing ? existing.createdAt : Date.now();
    } else {
      song.createdAt = Date.now();
    }
    await saveSong(song);
    currentSongId = song.id;
    currentSongTitle = name;
    lastSavedState = captureCurrentState();
    await refreshSongList();
    updateSaveBtn();
    updateSongIndicator();
    btn.innerHTML = CHECK_ICON;
    setTimeout(() => updateSaveBtn(), 1500);
  }

  async function loadSongById(id) {
    if (id === currentSongId) return;
    if (currentSongId && hasUnsavedChanges()) {
      const wantSave = confirm('目前有未儲存的變更，是否要先儲存？');
      if (wantSave) { await saveCurrent(); }
      else if (!confirm('確定不儲存並切換歌曲？')) return;
    }
    try {
      const song = cachedSongs.find(s => s.id === id);
      if (!song) { alert('找不到歌曲。'); return; }

      // 0. Reset previous playback state
      stopSync();
      currentLineIndex = -1;
      if (player && player.stopVideo) try { player.stopVideo(); } catch(e) {}
      if (audioEl && !audioEl.paused) audioEl.pause();
      if (manualPlaying) manualReset();
      document.getElementById('embedMode').style.display = 'block';
      document.getElementById('manualMode').style.display = 'none';
      useManualMode = false;
      document.getElementById('statusBadge').className = 'mode-badge';
      document.getElementById('statusBadge').textContent = 'IDLE';

      // 1. Load lyrics
      document.getElementById('lrcInput').value = song.lrcText;
      lyrics = parseLRCText(song.lrcText);
      renderLyrics();

      // 2. Apply offset
      offset = song.offset || 0;
      document.getElementById('offsetDisplay').textContent = offset.toFixed(1) + 's';

      // 3. Render lyrics with current font size
      if (lyrics.length > 0) updateActiveLine();

      // 4. Switch audio source & load
      const tabs = document.getElementById('audioSourceTabs').querySelectorAll('.tab');
      tabs.forEach(t => t.classList.remove('active'));

      if (song.audioSource === 'local') {
        useLocalAudio = true;
        useManualMode = false;
        document.getElementById('audioSourceYoutube').style.display = 'none';
        document.getElementById('audioSourceLocal').style.display = 'block';
        if (tabs[1]) tabs[1].classList.add('active');

        if (song.audioFileName) {
          document.getElementById('audioFileName').value = song.audioFileName;
          alert(`請選擇音檔「${song.audioFileName}」以播放伴奏。`);
          document.getElementById('audioFileInput').click();
        }
      } else {
        useLocalAudio = false;
        document.getElementById('audioSourceYoutube').style.display = 'block';
        document.getElementById('audioSourceLocal').style.display = 'none';
        if (tabs[0]) tabs[0].classList.add('active');

        if (song.youtubeId) {
          document.getElementById('ytUrl').value = 'https://www.youtube.com/watch?v=' + song.youtubeId;
          loadVideo();
        }
      }

      // 5. Track current song for save/update
      currentSongId = song.id;
      currentSongTitle = song.name;
      lastSavedState = captureCurrentState();
      updateSaveBtn();
      updateSongIndicator();
      renderSongList(cachedSongs);
      closeSongDrawer();
    } catch (err) {
      console.error('loadSongById error:', err);
      alert('載入歌曲時發生錯誤：' + err.message);
    }
  }

  async function deleteSongById(id, name) {
    if (!confirm(`確定要刪除「${name}」？`)) return;
    await deleteSong(id);
    if (currentSongId === id) {
      currentSongId = null;
      currentSongTitle = '';
      updateSaveBtn();
      updateSongIndicator();
    }
    await refreshSongList();
  }

  async function exportSongs() {
    const songs = await getAllSongs();
    if (songs.length === 0) { alert('歌曲庫是空的。'); return; }
    const json = JSON.stringify(songs, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'lyrics-flow-songs.json';
    a.click();
  }

  async function importSongs(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const songs = JSON.parse(e.target.result);
        if (!Array.isArray(songs)) throw new Error('格式錯誤');
        let count = 0;
        for (const song of songs) {
          if (song.name && song.lrcText) {
            // Assign new ID to avoid conflicts
            song.id = Date.now() + count;
            await saveSong(song);
            count++;
          }
        }
        await refreshSongList();
        alert(`已匯入 ${count} 首歌曲。`);
      } catch (err) {
        alert('匯入失敗：檔案格式不正確。');
      }
    };
    reader.readAsText(file, 'UTF-8');
    // Reset file input so same file can be imported again
    event.target.value = '';
  }

  // ========== Drawer & Save State ==========
  function toggleSongDrawer() {
    document.getElementById('drawerBackdrop').classList.toggle('open');
  }
  function closeSongDrawer() {
    document.getElementById('drawerBackdrop').classList.remove('open');
    closeDrawerMenu();
    document.getElementById('songSearchInput').value = '';
    renderSongList(cachedSongs);
  }
  function toggleDrawerMenu(e) {
    e.stopPropagation();
    document.getElementById('drawerMenuDropdown').classList.toggle('open');
  }
  function closeDrawerMenu() {
    document.getElementById('drawerMenuDropdown').classList.remove('open');
  }
  const SAVE_ICON = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
  const CHECK_ICON = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
  function updateSaveBtn() {
    const btn = document.getElementById('saveBtn');
    btn.innerHTML = SAVE_ICON;
    btn.title = currentSongId ? '更新目前歌曲' : '儲存為新歌曲';
  }
  function updateSongIndicator() {
    const el = document.getElementById('songIndicatorName');
    if (currentSongId && currentSongTitle) {
      el.textContent = currentSongTitle;
      el.classList.remove('unsaved');
    } else {
      el.textContent = '未儲存的歌曲';
      el.classList.add('unsaved');
    }
  }
  function startEditSongName() {
    const indicator = document.getElementById('songIndicator');
    const nameEl = document.getElementById('songIndicatorName');
    const current = currentSongTitle || '';
    const input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.placeholder = '輸入歌曲名稱';
    input.className = 'song-name-input';
    indicator.classList.add('editing');
    nameEl.replaceWith(input);
    input.focus();
    input.select();
    const finish = () => {
      const val = input.value.trim();
      if (val) currentSongTitle = val;
      const div = document.createElement('div');
      div.className = 'song-indicator-name' + (currentSongId && currentSongTitle ? '' : ' unsaved');
      div.id = 'songIndicatorName';
      div.textContent = currentSongTitle || '未儲存的歌曲';
      input.replaceWith(div);
      indicator.classList.remove('editing');
    };
    input.addEventListener('blur', finish);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
      if (e.key === 'Escape') { input.value = current; input.blur(); }
    });
  }
  let lastSavedState = null;

  function captureCurrentState() {
    return JSON.stringify({
      title: currentSongTitle,
      lrcText: document.getElementById('lrcInput').value,
      offset: offset,
      ytUrl: document.getElementById('ytUrl').value,
      audioFileName: document.getElementById('audioFileName').value,
    });
  }

  function hasUnsavedChanges() {
    if (!lastSavedState) return false;
    return captureCurrentState() !== lastSavedState;
  }

  function clearCurrentSong() {
    const hasContent = document.getElementById('lrcInput').value.trim() || lyrics.length > 0;
    if (!hasContent) {
      // Nothing to clear, just reset silently
    } else if (currentSongId && hasUnsavedChanges()) {
      // Loaded song with unsaved edits
      const wantSave = confirm('目前有未儲存的變更，是否要先儲存？');
      if (wantSave) { saveCurrent(); return; }
      if (!confirm('確定不儲存並清空目前內容？')) return;
    } else {
      if (!confirm('確定要清空目前的歌曲內容？')) return;
    }
    currentSongId = null;
    currentSongTitle = '';
    document.getElementById('lrcInput').value = '';
    document.getElementById('ytUrl').value = '';
    document.getElementById('audioFileName').value = '';
    renderSongList(cachedSongs);
    lyrics = [];
    renderLyrics();
    offset = 0;
    document.getElementById('offsetDisplay').textContent = '0.0s';
    stopSync();
    currentLineIndex = -1;
    // Destroy YouTube player
    if (player) {
      try { player.destroy(); } catch(e) {}
      player = null;
      playerReady = false;
    }
    // Recreate ytPlayer div for future use
    const wrapper = document.querySelector('.player-wrapper');
    if (wrapper && !document.getElementById('ytPlayer')) {
      const div = document.createElement('div');
      div.id = 'ytPlayer';
      wrapper.appendChild(div);
    }
    currentVideoId = null;
    // Reset playback UI
    document.getElementById('embedMode').style.display = 'block';
    document.getElementById('manualMode').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('timeDisplay').textContent = '00:00 / 00:00';
    document.getElementById('progressFill').style.width = '0%';
    // Reset local audio
    if (audioEl && !audioEl.paused) audioEl.pause();
    document.getElementById('audioPlaybackInfo').style.display = 'none';
    document.getElementById('audioControls').style.display = 'none';
    lastSavedState = null;
    updateSaveBtn();
    updateSongIndicator();
  }

  // ========== Audio Source Switching ==========
  function switchAudioSource(source, el) {
    document.getElementById('audioSourceYoutube').style.display = source === 'youtube' ? 'block' : 'none';
    document.getElementById('audioSourceLocal').style.display = source === 'local' ? 'block' : 'none';
    el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');

    if (source === 'local') {
      useLocalAudio = true;
      useManualMode = false;
      // Pause YouTube if playing
      if (player && player.pauseVideo) try { player.pauseVideo(); } catch(e) {}
      stopSync();
    } else {
      useLocalAudio = false;
      // Pause local audio if playing
      if (audioEl && !audioEl.paused) audioEl.pause();
      stopSync();
    }
  }

  // ========== Local Audio ==========
  function loadAudioFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    document.getElementById('audioFileName').value = file.name;

    audioEl = document.getElementById('audioPlayer');
    audioEl.src = URL.createObjectURL(file);

    // Show controls
    document.getElementById('audioPlaybackInfo').style.display = 'flex';
    document.getElementById('audioControls').style.display = 'flex';

    // Event bindings
    audioEl.onplay = function() {
      document.getElementById('audioStatusDot').className = 'status-dot playing';
      document.getElementById('statusBadge').className = 'mode-badge active';
      document.getElementById('statusBadge').textContent = 'PLAYING';
      document.getElementById('audioPlayBtn').textContent = '⏸ 暫停';
      startSync();
    };
    audioEl.onpause = function() {
      document.getElementById('audioStatusDot').className = 'status-dot paused';
      document.getElementById('statusBadge').className = 'mode-badge';
      document.getElementById('statusBadge').textContent = 'PAUSED';
      document.getElementById('audioPlayBtn').textContent = '▶ 播放';
      stopSync();
    };
    audioEl.onended = function() {
      document.getElementById('audioStatusDot').className = 'status-dot';
      document.getElementById('statusBadge').className = 'mode-badge';
      document.getElementById('statusBadge').textContent = 'ENDED';
      document.getElementById('audioPlayBtn').textContent = '▶ 播放';
      stopSync();
    };
    audioEl.ontimeupdate = function() {
      const cur = audioEl.currentTime;
      const dur = audioEl.duration || 0;
      document.getElementById('audioTimeDisplay').textContent =
        `${formatTime(cur)} / ${formatTime(dur)}`;
      const pct = dur > 0 ? (cur / dur) * 100 : 0;
      document.getElementById('audioProgressFill').style.width = pct + '%';
    };
  }

  function audioTogglePlay() {
    if (!audioEl || !audioEl.src) return;
    if (audioEl.paused) {
      audioEl.play();
    } else {
      audioEl.pause();
    }
  }

  function audioSeek(delta) {
    if (!audioEl) return;
    audioEl.currentTime = Math.max(0, Math.min(audioEl.duration || 0, audioEl.currentTime + delta));
    currentLineIndex = -1;
  }

  function audioSeekFromBar(event) {
    if (!audioEl || !audioEl.duration) return;
    const bar = document.getElementById('audioProgressBar');
    const rect = bar.getBoundingClientRect();
    const pct = (event.clientX - rect.left) / rect.width;
    audioEl.currentTime = pct * audioEl.duration;
    currentLineIndex = -1;
  }

  // ========== PieSocket (OBS Sync) ==========
  const piesocket = new PieSocket.default({
    clusterId: 'demo',
    apiKey: 'xlkQUJ7Y5BKQ1m0rNfNx2R1yhLBTu9mrVWOFdrnB',
    notifySelf: 0,
  });

  let syncChannel = null;
  piesocket.subscribe('lyrics-flow').then(ch => {
    syncChannel = ch;
    ch.listen('sync', (msg) => {
      if (msg.type === 'REQUEST_STATE') {
        broadcast('FULL_STATE', { lyrics, currentLineIndex, baseFontSize, baseLineHeight, offset });
      }
    });
    console.log('PieSocket connected');
  });

  function broadcast(type, data) {
    if (!syncChannel) return;
    try { syncChannel.publish('sync', { type, data }); } catch (e) {}
  }

  // ========== YouTube API ==========
  let playerReady = false;
  let pendingVideoId = null;

  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  tag.onerror = () => console.error('Failed to load YouTube IFrame API');
  document.head.appendChild(tag);

  function onYouTubeIframeAPIReady() {
    console.log('YouTube IFrame API loaded');
    // Don't create the player yet — wait until user loads a video
  }

  function createPlayer(videoId) {
    if (player) {
      try {
        // Player already exists, just load the new video
        player.loadVideoById(videoId);
        return;
      } catch (e) {
        // Player object exists but is broken — destroy and recreate
        console.warn('Player.loadVideoById failed, recreating player:', e);
        try { player.destroy(); } catch(e2) {}
        player = null;
        playerReady = false;
      }
    }
    // Ensure the target div exists
    if (!document.getElementById('ytPlayer')) {
      const wrapper = document.querySelector('.player-wrapper');
      if (wrapper) {
        const div = document.createElement('div');
        div.id = 'ytPlayer';
        wrapper.appendChild(div);
      }
    }
    player = new YT.Player('ytPlayer', {
      height: '100%',
      width: '100%',
      videoId: videoId,
      playerVars: {
        autoplay: 0,
        controls: 1,
        modestbranding: 1,
        rel: 0,
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
        onError: onPlayerError,
      }
    });
  }

  function onPlayerReady(event) {
    console.log('YouTube Player ready');
    playerReady = true;
  }

  function onPlayerError(event) {
    console.error('YouTube Player error:', event.data);
    const embedErrors = [101, 150, 153];
    if (embedErrors.includes(event.data)) {
      // Switch to manual timer mode
      switchToManualMode();
    } else {
      const codes = {2:'無效的影片 ID', 5:'不支援 HTML5', 100:'找不到影片'};
      alert('播放錯誤：' + (codes[event.data] || '未知錯誤 (' + event.data + ')'));
    }
  }

  function onPlayerStateChange(event) {
    const state = event.data;
    const dot = document.getElementById('statusDot');
    const badge = document.getElementById('statusBadge');

    if (state === YT.PlayerState.PLAYING) {
      dot.className = 'status-dot playing';
      badge.className = 'mode-badge active';
      badge.textContent = 'PLAYING';
      startSync();
    } else if (state === YT.PlayerState.PAUSED) {
      dot.className = 'status-dot paused';
      badge.className = 'mode-badge';
      badge.textContent = 'PAUSED';
      stopSync();
    } else if (state === YT.PlayerState.ENDED) {
      dot.className = 'status-dot';
      badge.className = 'mode-badge';
      badge.textContent = 'ENDED';
      stopSync();
    } else {
      dot.className = 'status-dot';
      badge.className = 'mode-badge';
      badge.textContent = 'IDLE';
    }
  }

  function extractVideoId(input) {
    input = input.trim();
    // Direct ID (11 chars)
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
    // Various YouTube URL formats
    const patterns = [
      /(?:youtube\.com\/watch\?.*v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
    ];
    for (const p of patterns) {
      const m = input.match(p);
      if (m) return m[1];
    }
    return null;
  }

  function loadVideo() {
    const input = document.getElementById('ytUrl').value;
    const videoId = extractVideoId(input);
    if (!videoId) {
      alert('無法解析 YouTube 連結，請確認格式正確。');
      return;
    }
    if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
      alert('YouTube API 尚未載入，請稍候再試。');
      return;
    }
    // Stop any current playback
    stopSync();
    currentLineIndex = -1;
    if (audioEl && !audioEl.paused) audioEl.pause();
    useLocalAudio = false;

    currentVideoId = videoId;
    // Reset to embed mode first
    useManualMode = false;
    document.getElementById('embedMode').style.display = 'block';
    document.getElementById('manualMode').style.display = 'none';
    manualReset();
    createPlayer(videoId);
  }

  // ========== LRC Parsing ==========
  function parseLRCText(text) {
    const lines = text.split('\n');
    const result = [];

    // Extract [ti:] for song title
    currentSongTitle = '';
    for (const line of lines) {
      const tiMatch = line.match(/^\[ti:\s*(.+?)\s*\]/i);
      if (tiMatch) { currentSongTitle = tiMatch[1]; break; }
    }

    for (const line of lines) {
      // Skip metadata tags like [ti:...], [ar:...], [al:...], etc.
      if (/^\[(?:ti|ar|al|by|offset|re|ve):/i.test(line)) continue;

      // Match multiple time tags on same line: [mm:ss.xx] or [mm:ss:xx] or [mm:ss]
      const timeRegex = /\[(\d{1,3}):(\d{2})(?:[.:](\d{1,3}))?\]/g;
      const times = [];
      let match;

      while ((match = timeRegex.exec(line)) !== null) {
        const min = parseInt(match[1]);
        const sec = parseInt(match[2]);
        let ms = 0;
        if (match[3]) {
          const msStr = match[3];
          ms = msStr.length === 3 ? parseInt(msStr) : parseInt(msStr) * 10;
        }
        times.push(min * 60 + sec + ms / 1000);
      }

      // Extract text (everything after the last time tag)
      const textPart = line.replace(/\[\d{1,3}:\d{2}(?:[.:]\d{1,3})?\]/g, '').trim();

      for (const t of times) {
        result.push({ time: t, text: textPart });
      }
    }

    // Sort by time
    result.sort((a, b) => a.time - b.time);
    return result;
  }

  function parseLRC() {
    const text = document.getElementById('lrcInput').value;
    if (!text.trim()) {
      alert('請先貼上 LRC 歌詞內容。');
      return;
    }
    lyrics = parseLRCText(text);
    renderLyrics();
  }

  function loadLRCFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    document.getElementById('lrcFileInput').value = file.name;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      document.getElementById('lrcInput').value = text;
      lyrics = parseLRCText(text);
      renderLyrics();
    };
    reader.readAsText(file, 'UTF-8');
  }

  // ========== Lyrics Rendering ==========
  function renderLyrics() {
    const container = document.getElementById('lyricsContainer');
    const info = document.getElementById('lyricsInfo');
    const countEl = document.getElementById('lineCount');

    // Remove only lyric lines, preserve emptyState
    container.querySelectorAll('.lyric-line').forEach(el => el.remove());

    const emptyState = document.getElementById('emptyState');

    if (lyrics.length === 0) {
      // Recreate emptyState if it was lost
      if (!emptyState) {
        const es = document.createElement('div');
        es.className = 'empty-state';
        es.id = 'emptyState';
        es.innerHTML = '<div class="icon">♪</div><p>1. 貼上 YouTube 伴奏連結<br>2. 貼上或載入 LRC 歌詞<br>3. 播放後歌詞會自動同步滾動</p>';
        container.appendChild(es);
      } else {
        emptyState.style.display = 'flex';
      }
      info.style.display = 'none';
      return;
    }

    if (emptyState) emptyState.style.display = 'none';
    info.style.display = 'block';
    countEl.textContent = lyrics.length;

    lyrics.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'lyric-line upcoming';
      div.id = `lyric-${index}`;
      div.style.fontSize = baseFontSize + 'px';
      div.style.lineHeight = baseLineHeight;
      div.onclick = () => seekToLyric(index);

      // Time tag (hover to see)
      const timeTag = document.createElement('span');
      timeTag.className = 'time-tag';
      timeTag.textContent = formatTime(item.time);
      div.appendChild(timeTag);

      // Text or interlude
      if (item.text === '' || item.text === '//') {
        div.classList.add('interlude');
        div.appendChild(document.createTextNode('間奏'));
      } else {
        div.appendChild(document.createTextNode(item.text));
      }

      container.appendChild(div);
    });

    currentLineIndex = -1;
    broadcast('LYRICS_LOADED', { lyrics });
  }

  // ========== Manual Timer State ==========
  let useManualMode = false;
  let manualTime = 0;        // seconds elapsed
  let manualPlaying = false;
  let manualTimerInterval = null;
  let manualLastTick = null;
  let currentVideoId = null;

  function switchToManualMode() {
    useManualMode = true;
    document.getElementById('embedMode').style.display = 'none';
    document.getElementById('manualMode').style.display = 'block';
    // Destroy the broken embed player
    if (player) {
      try { player.destroy(); } catch(e) {}
      player = null;
      playerReady = false;
    }
    // Recreate the ytPlayer div for potential future use
    const wrapper = document.querySelector('.player-wrapper');
    if (wrapper && !document.getElementById('ytPlayer')) {
      const div = document.createElement('div');
      div.id = 'ytPlayer';
      wrapper.appendChild(div);
    }
  }

  function openYouTubeExternal() {
    if (currentVideoId) {
      window.open('https://www.youtube.com/watch?v=' + currentVideoId, '_blank');
    }
  }

  function manualTogglePlay() {
    const btn = document.getElementById('manualPlayBtn');
    const dot = document.getElementById('statusDot');
    const badge = document.getElementById('statusBadge');

    if (manualPlaying) {
      // Pause
      manualPlaying = false;
      clearInterval(manualTimerInterval);
      manualTimerInterval = null;
      btn.textContent = '▶ 繼續';
      dot.className = 'status-dot paused';
      badge.className = 'mode-badge';
      badge.textContent = 'PAUSED';
      stopSync();
    } else {
      // Play
      manualPlaying = true;
      manualLastTick = performance.now();
      manualTimerInterval = setInterval(manualTick, 50);
      btn.textContent = '⏸ 暫停';
      dot.className = 'status-dot playing';
      badge.className = 'mode-badge active';
      badge.textContent = 'PLAYING';
      startSync();
    }
  }

  function manualTick() {
    const now = performance.now();
    manualTime += (now - manualLastTick) / 1000;
    manualLastTick = now;
    document.getElementById('manualTimerDisplay').textContent = formatTime(manualTime);
  }

  function manualSeek(delta) {
    manualTime = Math.max(0, manualTime + delta);
    document.getElementById('manualTimerDisplay').textContent = formatTime(manualTime);
    currentLineIndex = -1; // force re-sync
  }

  function manualReset() {
    manualTime = 0;
    manualPlaying = false;
    clearInterval(manualTimerInterval);
    manualTimerInterval = null;
    manualLastTick = null;
    document.getElementById('manualTimerDisplay').textContent = '00:00';
    document.getElementById('manualPlayBtn').textContent = '▶ 開始';
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusBadge').className = 'mode-badge';
    document.getElementById('statusBadge').textContent = 'IDLE';
    currentLineIndex = -1;
    stopSync();
    if (lyrics.length > 0) renderLyrics();
  }

  // ========== Sync Engine ==========
  function getCurrentTime() {
    if (useLocalAudio && audioEl) return audioEl.currentTime;
    if (useManualMode) return manualTime;
    if (player && player.getCurrentTime) return player.getCurrentTime();
    return 0;
  }

  function startSync() {
    if (syncInterval) return;
    syncInterval = setInterval(syncLyrics, 80);
  }

  function stopSync() {
    if (syncInterval) {
      clearInterval(syncInterval);
      syncInterval = null;
    }
  }

  function syncLyrics() {
    if (lyrics.length === 0) return;
    if (!useLocalAudio && !useManualMode && (!player || !player.getCurrentTime)) return;

    const rawTime = getCurrentTime();
    const currentTime = rawTime + offset;

    // Update time display (embed mode only)
    if (!useManualMode && player && player.getDuration) {
      const duration = player.getDuration() || 1;
      document.getElementById('timeDisplay').textContent =
        `${formatTime(rawTime)} / ${formatTime(duration)}`;
      const pct = (rawTime / duration) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
    }

    // Find current line
    let newIndex = -1;
    for (let i = lyrics.length - 1; i >= 0; i--) {
      if (currentTime >= lyrics[i].time) {
        newIndex = i;
        break;
      }
    }

    if (newIndex !== currentLineIndex) {
      currentLineIndex = newIndex;
      updateActiveLine();
      broadcast('SYNC_UPDATE', { currentLineIndex });
    }
  }

  function updateActiveLine() {
    const container = document.getElementById('lyricsContainer');
    const lines = container.querySelectorAll('.lyric-line');

    lines.forEach((line, i) => {
      line.classList.remove('active', 'passed', 'upcoming');

      if (i < currentLineIndex) {
        line.classList.add('passed');
        line.style.fontSize = baseFontSize + 'px';
        line.style.lineHeight = baseLineHeight;
      } else if (i === currentLineIndex) {
        line.classList.add('active');
        line.style.fontSize = (baseFontSize + 4) + 'px';
        line.style.lineHeight = baseLineHeight;
      } else {
        line.classList.add('upcoming');
        line.style.fontSize = baseFontSize + 'px';
        line.style.lineHeight = baseLineHeight;
      }
    });

    // Scroll to active line
    if (currentLineIndex >= 0) {
      const activeLine = document.getElementById(`lyric-${currentLineIndex}`);
      if (activeLine) {
        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  // ========== Controls ==========
  function seekToLyric(index) {
    const time = lyrics[index].time - offset;
    if (useLocalAudio && audioEl) {
      audioEl.currentTime = Math.max(0, time);
      currentLineIndex = -1;
    } else if (useManualMode) {
      manualTime = Math.max(0, time);
      document.getElementById('manualTimerDisplay').textContent = formatTime(manualTime);
      currentLineIndex = -1;
    } else if (player && player.seekTo) {
      player.seekTo(Math.max(0, time), true);
    }
  }

  function seekFromBar(event) {
    if (!player || !player.getDuration) return;
    const bar = document.getElementById('progressBar');
    const rect = bar.getBoundingClientRect();
    const pct = (event.clientX - rect.left) / rect.width;
    const duration = player.getDuration();
    player.seekTo(pct * duration, true);
  }

  function adjustOffset(delta) {
    offset += delta;
    offset = Math.round(offset * 10) / 10;
    document.getElementById('offsetDisplay').textContent = offset.toFixed(1) + 's';
    // Re-sync immediately
    currentLineIndex = -1;
    broadcast('OFFSET', { offset });
  }

  function adjustFontSize(delta) {
    baseFontSize = Math.max(14, Math.min(60, baseFontSize + delta));
    document.getElementById('fontSizeDisplay').textContent = baseFontSize + 'px';
    broadcast('FONT_SIZE', { baseFontSize });
    if (lyrics.length > 0) updateActiveLine();
  }

  function adjustLineHeight(delta) {
    baseLineHeight = Math.max(1.0, Math.min(3.0, +(baseLineHeight + delta).toFixed(1)));
    document.getElementById('lineHeightDisplay').textContent = baseLineHeight.toFixed(1);
    broadcast('LINE_HEIGHT', { baseLineHeight });
    if (lyrics.length > 0) updateActiveLine();
  }

  function formatTime(seconds) {
    if (!seconds || seconds < 0) seconds = 0;
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }

  function switchTab(tabName, el) {
    document.getElementById('tabPaste').style.display = tabName === 'paste' ? 'block' : 'none';
    document.getElementById('tabFile').style.display = tabName === 'file' ? 'block' : 'none';
    el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  function toggleOBSMode() {
    isOBSMode = !isOBSMode;
    document.body.classList.toggle('obs-mode', isOBSMode);
  }

  function copyOBSUrl() {
    const base = window.location.href.replace(/[^/]*$/, '');
    const obsUrl = base + 'obs.html';
    const btn = document.getElementById('obsUrlBtn');
    navigator.clipboard.writeText(obsUrl).then(() => {
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 1500);
    }).catch(() => {
      prompt('請手動複製此 URL：', obsUrl);
    });
  }

    // ========== Keyboard Shortcuts ==========
    function handlePlayPause() {
      if (useLocalAudio && audioEl) { audioTogglePlay(); return; }
      if (useManualMode) { manualTogglePlay(); return; }
      if (player && playerReady) {
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      }
  }

  document.addEventListener('keydown', (e) => {
    const tag = e.target.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
    if (e.key === 'Escape') { closeSongDrawer(); return; }
    if (e.code === 'Space') { e.preventDefault(); handlePlayPause(); return; }
    if (e.key === 'ArrowLeft') { e.preventDefault(); adjustOffset(e.shiftKey ? -0.5 : -0.1); return; }
    if (e.key === 'ArrowRight') { e.preventDefault(); adjustOffset(e.shiftKey ? 0.5 : 0.1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); adjustFontSize(2); return; }
    if (e.key === 'ArrowDown') { e.preventDefault(); adjustFontSize(-2); return; }
    if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveCurrent(); return; }
  });

  // ========== Init ==========
  refreshSongList().catch(e => console.error('Failed to load song library:', e));
</script>

</body>
</html>
